"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}var Rule=function(){function t(e){_classCallCheck(this,t),Object.assign(this,{$options:e,required:e.required,min:e.min,max:e.min,type:e.type,pattern:e.pattern,validator:e.validator,trigger:e.trigger,maxWidth:e.maxWidth})}return _createClass(t,[{key:"message",get:function(){return _tools.UtilTools.getFuncText(this.$options.message)}}]),t}(),_default={name:"VxeForm",props:{data:Object,size:String,span:[String,Number],align:String,titleAlign:String,titleWidth:[String,Number],rules:Object},data:function(){return{collapseAll:!0,sourceData:null,invalids:[]}},provide:function(){return{$vxeform:this}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize}},watch:{data:function(){this.loadForm()}},created:function(){this.loadForm()},render:function(e){return e("form",{class:["vxe-form","vxe-row",_defineProperty({},"size--".concat(this.vSize),this.vSize)],on:{submit:this.submitEvent,reset:this.resetEvent}},this.$slots.default)},methods:{loadForm:function(){this.data&&(this.sourceData=_xeUtils.default.clone(this.data,!0))},toggleCollapse:function(){return this.collapseAll=!this.collapseAll,this.$nextTick()},submitEvent:function(t){var i=this;t.preventDefault(),this.beginValidate().then(function(){i.$emit("submit",{data:i.data,$form:i},t)}).catch(function(e){i.$emit("submit-invalid",e,t)})},resetEvent:function(e){e.preventDefault();var i=this.data,r=this.sourceData;i&&this.$children.forEach(function(e){var t=e.field;t&&_xeUtils.default.set(i,t,_xeUtils.default.get(r,t,null))}),this.clearValidate(),this.$emit("reset",{data:i,$form:this},e)},clearValidate:function(t){return t?_xeUtils.default.remove(this.invalids,function(e){return e.property===t}):this.invalids=[],this.$nextTick()},validate:function(e){return this.beginValidate(e)},beginValidate:function(t,e){var n=this,i=this.data,r=this.rules,a={},s=[],l=!0;return this.clearValidate(),i&&r?(this.$children.forEach(function(e){var r=e.field;r&&s.push(new Promise(function(e,i){n.validItemRules(t||"all",r).then(e).catch(function(e){var t={rule:e.rule,rules:e.rules,property:r};return a[r]||(a[r]=[]),a[r].push(t),n.invalids.push(t),i(t)})}))}),Promise.all(s).then(function(){e&&e(l)}).catch(function(){return l=!1,e&&e(l,a),Promise.reject(a)})):(e&&e(l),Promise.resolve())},validItemRules:function(n,a,e){var t=this.data,i=this.rules,s=[],l=[];if(a&&i){var u=_xeUtils.default.get(i,a);if(u){var o=_xeUtils.default.isUndefined(e)?_xeUtils.default.get(t,a):e;u.forEach(function(r){l.push(new Promise(function(i){if("all"!==n&&r.trigger&&n!==r.trigger)i();else if(_xeUtils.default.isFunction(r.validator))r.validator(r,o,function(e){if(_xeUtils.default.isError(e)){var t={type:"custom",trigger:r.trigger,message:e.message,rule:new Rule(r)};s.push(new Rule(t))}return i()},{rules:u,property:a});else{var e="number"===r.type,t=e?_xeUtils.default.toNumber(o):_xeUtils.default.getSize(o);null==o||""===o?r.required&&s.push(new Rule(r)):(e&&isNaN(o)||!isNaN(r.min)&&t<parseFloat(r.min)||!isNaN(r.max)&&t>parseFloat(r.max)||r.pattern&&!(r.pattern.test?r.pattern:new RegExp(r.pattern)).test(o))&&s.push(new Rule(r)),i()}}))})}}return Promise.all(l).then(function(){if(s.length){var e={rules:s,rule:s[0]};return Promise.reject(e)}})},updateStatus:function(e,t){var n=this,a=e.property;a&&this.validItemRules("change",a,t).then(function(){n.clearValidate(a)}).catch(function(e){var t=e.rule,i=e.rules,r=n.invalids.find(function(e){return e.property===a});r?(r.rule=t,r.rules=i):n.invalids.push({rule:t,rules:i,property:a})})}}};exports.default=_default;