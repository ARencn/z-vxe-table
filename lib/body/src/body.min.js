"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var scrollProcessTimeout,updateLeftScrollingTimeput,_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function handleLocation(e,t,o,l,r){var n=t.indexOf(l),i=o.indexOf(r);e.active=-1<n&&-1<i,e.top=0===n&&-1<i,e.bottom=n===t.length-1&&-1<i,e.left=-1<n&&0===i,e.right=-1<n&&i===o.length-1}function countTreeExpand(e,t){var o=t.$table,l=e[o.treeOpts.children],r=1;if(o.isTreeExpandByRow(e))for(var n=0;n<l.length;n++)r+=countTreeExpand(l[n],t);return r}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,t){var o=e.$table,l=e.$rowIndex,r=1;return l&&(r=countTreeExpand(t[l-1],e)),o.rowHeight*r-(l?1:12-getOffsetSize(o))}function renderLine(e,t,o,l,r,n){var i=n.column,c=o.treeConfig,s=o.treeOpts;return i.slots&&i.slots.line?i.slots.line.call(o,n,e):i.treeNode&&c&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(n,r),"px"),left:"".concat(l*s.indent+(l?2-getOffsetSize(o):0)+16,"px")}})])]:[]}function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.optimizeOpts.delayHover}function renderColumn(e,t,o,l,r,n,i,c,s,d,a,u,p,f,h,x){var m,y,w=o._e,g=o.$listeners,v=o.tableData,b=o.height,_=o.overflowX,T=o.scrollXLoad,$=o.scrollYLoad,I=o.cellOffsetWidth,S=o.highlightCurrentRow,O=o.showOverflow,C=o.showAllOverflow,k=o.align,L=o.currentColumn,P=o.cellClassName,q=o.cellStyle,E=o.spanMethod,R=o.keyboardConfig,H=o.expandOpts,U=o.radioOpts,D=o.checkboxOpts,A=o.treeOpts,B=o.mouseConfig,W=o.mouseOpts,M=o.editConfig,N=o.editOpts,X=o.editRules,Y=o.validOpts,z=o.editStore,F=o.validStore,j=_xeUtils.default.isBoolean(C)?C:O,K=u.editRender,G=u.align,V=u.showOverflow,J=u.renderWidth,Q=u.columnKey,Z=u.className,ee=u.treeNode,te=z.checked,oe=z.selected,le=z.actived,re=z.copyed,ne=B&&W.selected,ie=B&&(W.range||W.checked),ce=R&&R.isCut,se=i?u.fixed!==i:u.fixed&&_,de=_xeUtils.default.isUndefined(V)||_xeUtils.default.isNull(V)?j:V,ae=G||k,ue="ellipsis"===de,pe="title"===de,fe=!0===de||"tooltip"===de,he=pe||fe||ue,xe={},me={},ye={},we={},ge=F.row===s&&F.column===u,ve=X&&("default"===Y.message?b||1<v.length:"inline"===Y.message),be={"data-colid":u.id},_e=K&&M&&"dblclick"===N.trigger,Te={$table:o,$seq:l,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,isHidden:se,data:v,items:x};if(!T&&!$||he||(ue=he=!0),(pe||fe||g["cell-mouseenter"])&&(xe.mouseenter=function(e){if(!isOperateMouse(o)){var t={$table:o,$seq:l,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.currentTarget};pe?_tools.DomTools.updateCellTitle(e):fe&&o.triggerTooltipEvent(e,t),_tools.UtilTools.emitEvent(o,"cell-mouseenter",[t,e])}}),(fe||g["cell-mouseleave"])&&(xe.mouseleave=function(e){isOperateMouse(o)||(fe&&o.handleTargetLeaveEvent(),_tools.UtilTools.emitEvent(o,"cell-mouseleave",[{$table:o,$seq:l,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.currentTarget},e]))}),(D.range||ne||ie)&&(xe.mousedown=function(e){o.triggerCellMousedownEvent(e,{$table:o,$seq:l,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.currentTarget})}),(S||g["cell-click"]||K&&M||"row"===H.trigger||"cell"===H.trigger||"row"===U.trigger||"radio"===u.type&&"cell"===U.trigger||"row"===D.trigger||"checkbox"===u.type|"selection"===u.type&&"cell"===D.trigger||"row"===A.trigger||u.treeNode&&"cell"===A.trigger)&&(xe.click=function(e){o.triggerCellClickEvent(e,{$table:o,$seq:l,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.currentTarget})}),(_e||g["cell-dblclick"])&&(xe.dblclick=function(e){o.triggerCellDBLClickEvent(e,{$table:o,$seq:l,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.currentTarget})}),E){var $e=E(Te)||{},Ie=$e.rowspan,Se=void 0===Ie?1:Ie,Oe=$e.colspan,Ce=void 0===Oe?1:Oe;if(!Se||!Ce)return null;be.rowspan=Se,be.colspan=Ce}!se&&K&&M&&N.showStatus&&(y=o.isUpdateByRow(s,u.property)),se||i||(ie&&(handleLocation(me,te.rows,te.columns,s,u),handleLocation(ye,te.tRows,te.tColumns,s,u)),ce&&handleLocation(we,re.rows,re.columns,s,u));var ke="seq"===u.type||"index"===u.type?"seq":u.type;return e("td",{class:["vxe-body--column",u.id,(m={},_defineProperty(m,"col--".concat(ae),ae),_defineProperty(m,"col--".concat(ke),ke),_defineProperty(m,"col--last",f===h.length-1),_defineProperty(m,"col--tree-node",ee),_defineProperty(m,"col--edit",K),_defineProperty(m,"edit--visible",K&&"visible"===K.type),_defineProperty(m,"fixed--hidden",se),_defineProperty(m,"col--ellipsis",he),_defineProperty(m,"col--actived",M&&K&&le.row===s&&(le.column===u||"row"===N.mode)),_defineProperty(m,"col--checked",me.active),_defineProperty(m,"col--checked-top",me.top),_defineProperty(m,"col--checked-bottom",me.bottom),_defineProperty(m,"col--checked-left",me.left),_defineProperty(m,"col--checked-right",me.right),_defineProperty(m,"col--checked-temp",ye.active),_defineProperty(m,"col--checked-temp-top",ye.top),_defineProperty(m,"col--checked-temp-bottom",ye.bottom),_defineProperty(m,"col--checked-temp-left",ye.left),_defineProperty(m,"col--checked-temp-right",ye.right),_defineProperty(m,"col--selected",ne&&K&&oe.row===s&&oe.column===u),_defineProperty(m,"col--copyed",we.active),_defineProperty(m,"col--copyed-top",we.top),_defineProperty(m,"col--copyed-bottom",we.bottom),_defineProperty(m,"col--copyed-left",we.left),_defineProperty(m,"col--copyed-right",we.right),_defineProperty(m,"col--dirty",y),_defineProperty(m,"col--valid-error",ge),_defineProperty(m,"col--current",L===u),m),_tools.UtilTools.getClass(Z,Te),_tools.UtilTools.getClass(P,Te)],key:Q||(o.columnKey?u.id:p),attrs:be,style:q?_xeUtils.default.isFunction(q)?q(Te):q:null,on:xe},j&&se&&!E?[e("div",{class:["vxe-cell",{"c--title":pe,"c--tooltip":fe,"c--ellipsis":ue}]})]:renderLine(e,t,o,c,x,Te).concat([e("div",{class:["vxe-cell",{"c--title":pe,"c--tooltip":fe,"c--ellipsis":ue}],style:{width:he?"".concat(J-I,"px"):null}},u.renderCell(e,Te)),ve?ge?e("div",{class:"vxe-cell--valid",style:F.rule&&F.rule.maxWidth?{width:"".concat(F.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},F.content)]):w():null,ie&&!i?e("span",{class:"vxe-body--column-checked-lt"}):null,ie&&!i?e("span",{class:"vxe-body--column-checked-rb"}):null,ce&&!i?e("span",{class:"vxe-body--column-copyed-lt"}):null,ce&&!i?e("span",{class:"vxe-body--column-copyed-rb"}):null,me.bottom&&me.right?e("span",{class:"vxe-body--column-checked-corner",on:{mousedown:function(e){o.triggerCornerMousedownEvent({$table:o,$seq:l,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.target.parentNode},e)}}}):null]))}function renderRows(d,a,u,p,f,h,x,m){var y=u.stripe,w=u.rowKey,g=u.highlightHoverRow,v=u.highlightCurrentRow,b=u.rowClassName,_=u.rowStyle,T=u.currentRow,$=u.hoverRow,I=u.treeConfig,S=u.treeOpts,O=u.treeExpandeds,C=u.scrollYLoad,k=u.scrollYStore,L=u.editStore,P=u.rowExpandeds,q=u.radioOpts,E=u.checkboxOpts,R=u.expandColumn,H=u.getColumnIndex,U=[];return x.forEach(function(l,r){var e={},n=r,i=n+1;C&&(i+=k.startIndex),n=u.getRowIndex(l),g&&(e.mouseenter=function(e){isOperateMouse(u)||l!==$&&u.triggerHoverEvent(e,{row:l,rowIndex:n})},e.mouseleave=function(){isOperateMouse(u)||(u.hoverRow=null)});var c=_tools.UtilTools.getRowid(u,l,n);if(U.push(d("tr",{class:["vxe-body--row",{"row--stripe":y&&0<n&&(n+1)%2==0,"row--current":v&&l===T,"row--hover":l===$,"row--new":-1<L.insertList.indexOf(l),"row--radio":q.highlight&&u.selectRow===l,"row--cheched":E.highlight&&u.isCheckedByCheckboxRow(l)},b?_xeUtils.default.isFunction(b)?b({$table:u,$seq:p,seq:i,rowid:c,fixedType:h,rowLevel:f,row:l,rowIndex:n,$rowIndex:r}):b:""],attrs:{"data-rowid":c},style:_?_xeUtils.default.isFunction(_)?_({$table:u,$seq:p,seq:i,rowid:c,fixedType:h,rowLevel:f,row:l,rowIndex:n,$rowIndex:r}):_:null,key:w||I?c:r,on:e},m.map(function(e,t){var o=H(e);return renderColumn(d,a,u,p,i,c,h,f,l,n,r,e,o,t,m,x)}))),P.length&&-1<P.indexOf(l)){var t,o=H(R);I&&(t={paddingLeft:"".concat(f*S.indent+30,"px")}),R&&U.push(d("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(c),style:_?_xeUtils.default.isFunction(_)?_({$table:u,$seq:p,seq:i,rowid:c,fixedType:h,rowLevel:f,row:l,rowIndex:n,$rowIndex:r,isExpanded:!0}):_:null,on:e},[d("td",{class:"vxe-body--expanded-column",attrs:{colspan:m.length}},[d("div",{class:["vxe-body--expanded-cell",{"fixed--hidden":h}],style:t},[R.renderData(d,{$table:u,seq:i,rowid:c,row:l,rowIndex:n,column:R,columnIndex:o,fixed:h,level:f})])])]))}if(I&&O.length){var s=l[S.children];s&&s.length&&-1<O.indexOf(l)&&U.push.apply(U,_toConsumableArray(renderRows(d,a,u,p?"".concat(p,".").concat(i):"".concat(i),f+1,h,s,m)))}}),U}function syncBodyScroll(e,t,o){(t||o)&&(t&&(t.onscroll=null,t.scrollTop=e),o&&(o.onscroll=null,o.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){t&&(t.onscroll=t._onscroll),o&&(o.onscroll=o._onscroll)},100))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,collectColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(o){var e=this._e,t=this.$parent,l=this.fixedColumn,r=this.fixedType,n=t.$scopedSlots,i=t.id,c=t.maxHeight,s=t.height,d=t.parentHeight,a=t.tableData,u=t.tableColumn,p=t.headerHeight,f=t.showFooter,h=t.showOverflow,x=t.showAllOverflow,m=t.spanMethod,y=t.footerHeight,w=t.tableHeight,g=t.tableWidth,v=t.overflowY,b=t.scrollbarHeight,_=t.scrollbarWidth,T=t.scrollXStore,$=t.scrollXLoad,I=t.scrollYLoad,S=t.scrollYStore,O=t.emptyRender,C=t.emptyOpts,k=_xeUtils.default.isBoolean(x)?x:h,L=0,P={};s&&(L="auto"===s?d:(_tools.DomTools.isScale(s)?Math.floor(parseInt(s)/100*d):_xeUtils.default.toNumber(s))-t.getExcludeHeight(),f&&(L+=b+1)),c?(c="auto"===c?d:_tools.DomTools.isScale(c)?Math.floor(parseInt(c)/100*d):_xeUtils.default.toNumber(c),P.maxHeight="".concat(r?c-p-(f?0:b):c-p,"px")):0<L&&(P.height="".concat(r?(0<L?L-p-y:w)-(f?0:b):L-p-y,"px")),r&&k&&!m?g=(u=l).reduce(function(e,t){return e+t.renderWidth},0):$&&(r&&!m&&(u=l),g=u.reduce(function(e,t){return e+t.renderWidth},0));var q,E={width:g?"".concat(g,"px"):g,marginTop:S.topSpaceHeight?"".concat(S.topSpaceHeight,"px"):null,marginLeft:r?null:T.leftSpaceWidth?"".concat(T.leftSpaceWidth,"px"):null};if(v&&r&&(_tools.DomTools.browse["-moz"]||_tools.DomTools.browse.safari)&&(E.paddingRight="".concat(_,"px")),n.empty)q=n.empty.call(this,{$table:this},o);else{var R=O?_vXETable.default.renderer.get(C.name):null;q=R&&R.renderEmpty?R.renderEmpty(o,C,{$table:this},{$table:this}):_conf.default.i18n("vxe.table.emptyText")}return o("div",{class:["vxe-table--body-wrapper",r?"fixed--".concat(r,"-wrapper"):"body--wrapper"],attrs:{"data-tid":i},style:P},[r?e():o("div",{class:"vxe-body--x-space",style:{width:$?"".concat(t.tableWidth,"px"):""}}),o("div",{class:"vxe-body--y-space",style:{height:I?"".concat(S.ySpaceHeight,"px"):""}}),o("table",{class:"vxe-table--body",attrs:{"data-tid":i,cellspacing:0,cellpadding:0,border:0},style:E},[o("colgroup",u.map(function(e,t){return o("col",{attrs:{name:e.id},style:{width:"".concat(e.renderWidth,"px")},key:t})})),o("tbody",renderRows(o,this,t,"",0,r,a,u))]),r?null:o("div",{class:"vxe-table--empty-block",style:{width:g?"".concat(g,"px"):g}},[o("div",{class:"vxe-table--empty-content"},q)])])},methods:{scrollEvent:function(e){var t=this.$parent,o=this.fixedType,l=this.lastScrollTop,r=this.lastScrollLeft,n=t.$refs,i=t.highlightHoverRow,c=t.scrollXLoad,s=t.scrollYLoad,d=t.triggerScrollXEvent,a=t.triggerScrollYEvent,u=n.tableHeader,p=n.tableBody,f=n.leftBody,h=n.rightBody,x=n.tableFooter,m=u?u.$el:null,y=x?x.$el:null,w=p.$el,g=f?f.$el:null,v=h?h.$el:null,b=w.scrollTop,_=w.scrollLeft,T=r!==_,$=l!==b;i&&t.clearHoverRow(),g&&"left"===o?syncBodyScroll(b=g.scrollTop,w,v):v&&"right"===o?syncBodyScroll(b=v.scrollTop,w,g):(m&&(m.scrollLeft=w.scrollLeft),y&&(y.scrollLeft=w.scrollLeft),(g||v)&&(clearTimeout(updateLeftScrollingTimeput),updateLeftScrollingTimeput=setTimeout(t.checkScrolling,_tools.DomTools.browse.msie?200:20),syncBodyScroll(b,g,v))),c&&d(e),s&&a(e),t.lastScrollTop=b,t.lastScrollLeft=_,t.lastScrollTime=Date.now(),_tools.UtilTools.emitEvent(t,"scroll",[{type:"body",fixed:o,scrollTop:b,scrollLeft:_,isX:T,isY:$,$table:t},e])}}};exports.default=_default;