"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var scrollProcessTimeout,updateLeftScrollingTimeput,_xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,o,l){return o in e?Object.defineProperty(e,o,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[o]=l,e}function handleLocation(e,o,l,t,r){var n=o.indexOf(t),i=l.indexOf(r);e.active=-1<n&&-1<i,e.top=0===n&&-1<i,e.bottom=n===o.length-1&&-1<i,e.left=-1<n&&0===i,e.right=-1<n&&i===l.length-1}function countTreeExpand(e,o){var l=o.$table,t=e[l.treeOpts.children],r=1;if(l.isTreeExpandByRow(e))for(var n=0;n<t.length;n++)r+=countTreeExpand(t[n],o);return r}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,o){var l=e.$table,t=e.$rowIndex,r=1;return t&&(r=countTreeExpand(o[t-1],e)),l.rowHeight*r-(t?1:12-getOffsetSize(l))}function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.optimizeOpts.delayHover}function renderColumn(e,o,l,t,r,n,i,c,s,d,a,u,p,f,h,x){var m,w,y=l._e,g=l.$listeners,v=l.tableData,b=l.height,_=l.overflowX,$=l.scrollXLoad,T=l.scrollYLoad,I=l.cellOffsetWidth,S=l.highlightCurrentRow,O=l.showOverflow,P=l.showAllOverflow,k=l.align,C=l.currentColumn,L=l.cellClassName,q=l.cellStyle,R=l.spanMethod,E=l.keyboardConfig,U=l.expandOpts,H=l.radioOpts,D=l.checkboxOpts,B=l.treeOpts,M=l.mouseConfig,N=l.mouseOpts,W=l.editConfig,z=l.editOpts,Y=l.editRules,A=l.validOpts,X=l.editStore,F=l.validStore,K=_xeUtils.default.isBoolean(P)?P:O,j=u.editRender,G=u.align,V=u.showOverflow,J=u.renderWidth,Q=u.columnKey,Z=u.className,ee=u.treeNode,oe=X.checked,le=X.selected,te=X.actived,re=X.copyed,ne=M&&N.selected,ie=M&&N.checked,ce=E&&E.isCut,se=i?u.fixed!==i:u.fixed&&_,de=_xeUtils.default.isUndefined(V)||_xeUtils.default.isNull(V)?K:V,ae=G||k,ue="ellipsis"===de,pe="title"===de,fe=!0===de||"tooltip"===de,he=pe||fe||ue,xe={},me={},we={},ye={},ge=F.row===s&&F.column===u,ve=Y&&("default"===A.message?b||1<v.length:"inline"===A.message),be={"data-colid":u.id},_e=j&&W&&"dblclick"===z.trigger,$e={$table:l,$seq:t,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,isHidden:se,data:v,items:x};if(!$&&!T||he||(ue=he=!0),(pe||fe||g["cell-mouseenter"])&&(xe.mouseenter=function(e){if(!isOperateMouse(l)){var o={$table:l,$seq:t,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.currentTarget};pe?_tools.DomTools.updateCellTitle(e):fe&&l.triggerTooltipEvent(e,o),_tools.UtilTools.emitEvent(l,"cell-mouseenter",[o,e])}}),(fe||g["cell-mouseleave"])&&(xe.mouseleave=function(e){isOperateMouse(l)||(fe&&l.handleTargetLeaveEvent(),_tools.UtilTools.emitEvent(l,"cell-mouseleave",[{$table:l,$seq:t,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.currentTarget},e]))}),(D.range||ne||ie)&&(xe.mousedown=function(e){l.triggerCellMousedownEvent(e,{$table:l,$seq:t,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.currentTarget})}),(S||g["cell-click"]||j&&W||"row"===U.trigger||"cell"===U.trigger||"row"===H.trigger||"radio"===u.type&&"cell"===H.trigger||"row"===D.trigger||"checkbox"===u.type|"selection"===u.type&&"cell"===D.trigger||"row"===B.trigger||u.treeNode&&"cell"===B.trigger)&&(xe.click=function(e){l.triggerCellClickEvent(e,{$table:l,$seq:t,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.currentTarget})}),(_e||g["cell-dblclick"])&&(xe.dblclick=function(e){l.triggerCellDBLClickEvent(e,{$table:l,$seq:t,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.currentTarget})}),R){var Te=R($e)||{},Ie=Te.rowspan,Se=void 0===Ie?1:Ie,Oe=Te.colspan,Pe=void 0===Oe?1:Oe;if(!Se||!Pe)return null;be.rowspan=Se,be.colspan=Pe}!se&&W&&z.showStatus&&(w=l.isUpdateByRow(s,u.property)),se||i||(ie&&(handleLocation(me,oe.rows,oe.columns,s,u),handleLocation(we,oe.tRows,oe.tColumns,s,u)),ce&&handleLocation(ye,re.rows,re.columns,s,u));var ke="seq"===u.type||"index"===u.type?"seq":u.type;return e("td",{class:["vxe-body--column",u.id,(_defineProperty(m={},"col--".concat(ae),ae),_defineProperty(m,"col--".concat(ke),ke),_defineProperty(m,"col--last",f===h.length-1),_defineProperty(m,"col--tree-node",ee),_defineProperty(m,"col--edit",j),_defineProperty(m,"edit--visible",j&&"visible"===j.type),_defineProperty(m,"fixed--hidden",se),_defineProperty(m,"col--ellipsis",he),_defineProperty(m,"col--actived",W&&j&&te.row===s&&(te.column===u||"row"===z.mode)),_defineProperty(m,"col--checked",me.active),_defineProperty(m,"col--checked-top",me.top),_defineProperty(m,"col--checked-bottom",me.bottom),_defineProperty(m,"col--checked-left",me.left),_defineProperty(m,"col--checked-right",me.right),_defineProperty(m,"col--checked-temp",we.active),_defineProperty(m,"col--checked-temp-top",we.top),_defineProperty(m,"col--checked-temp-bottom",we.bottom),_defineProperty(m,"col--checked-temp-left",we.left),_defineProperty(m,"col--checked-temp-right",we.right),_defineProperty(m,"col--selected",ne&&j&&le.row===s&&le.column===u),_defineProperty(m,"col--copyed",ye.active),_defineProperty(m,"col--copyed-top",ye.top),_defineProperty(m,"col--copyed-bottom",ye.bottom),_defineProperty(m,"col--copyed-left",ye.left),_defineProperty(m,"col--copyed-right",ye.right),_defineProperty(m,"col--dirty",w),_defineProperty(m,"col--valid-error",ge),_defineProperty(m,"col--current",C===u),m),_tools.UtilTools.getClass(Z,$e),_tools.UtilTools.getClass(L,$e)],key:Q||(l.columnKey?u.id:p),attrs:be,style:q?_xeUtils.default.isFunction(q)?q($e):q:null,on:xe},K&&se?[e("div",{class:["vxe-cell",{"c--title":pe,"c--tooltip":fe,"c--ellipsis":ue}]})]:renderLine(e,o,l,c,x,$e).concat([e("div",{class:["vxe-cell",{"c--title":pe,"c--tooltip":fe,"c--ellipsis":ue}],style:{width:he?"".concat(J-I,"px"):null}},u.renderCell(e,$e)),ve?ge?e("div",{class:"vxe-cell--valid",style:F.rule&&F.rule.width?{width:"".concat(F.rule.width,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},F.content)]):y():null,ie&&!i?e("span",{class:"vxe-body--column-checked-lt"}):null,ie&&!i?e("span",{class:"vxe-body--column-checked-rb"}):null,ce&&!i?e("span",{class:"vxe-body--column-copyed-lt"}):null,ce&&!i?e("span",{class:"vxe-body--column-copyed-rb"}):null,me.bottom&&me.right?e("span",{class:"vxe-body--column-checked-corner",on:{mousedown:function(e){l.triggerCornerMousedownEvent({$table:l,$seq:t,seq:r,rowid:n,row:s,rowIndex:d,$rowIndex:a,column:u,columnIndex:p,$columnIndex:f,fixed:i,level:c,cell:e.target.parentNode},e)}}}):null]))}function renderLine(e,o,l,t,r,n){var i=n.column,c=l.treeConfig,s=l.treeOpts;return i.slots&&i.slots.line?i.slots.line.call(l,n,e):i.treeNode&&c&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(n,r),"px"),left:"".concat(t*s.indent+(t?2-getOffsetSize(l):0)+16,"px")}})])]:[]}function renderRows(d,a,u,p,f,h,x,m){var w=u.stripe,y=u.rowKey,g=u.highlightHoverRow,v=u.highlightCurrentRow,b=u.rowClassName,_=u.rowStyle,$=u.currentRow,T=u.hoverRow,I=u.treeConfig,S=u.treeOpts,O=u.treeExpandeds,P=u.scrollYLoad,k=u.scrollYStore,C=u.editStore,L=u.rowExpandeds,q=u.radioOpts,R=u.checkboxOpts,E=u.expandColumn,U=u.getColumnIndex,H=[];return x.forEach(function(t,r){var e={},n=r,i=n+1;P&&(i+=k.startIndex),n=u.getRowIndex(t),g&&(e.mouseenter=function(e){isOperateMouse(u)||t!==T&&u.triggerHoverEvent(e,{row:t,rowIndex:n})},e.mouseleave=function(e){isOperateMouse(u)||(u.hoverRow=null)});var c=_tools.UtilTools.getRowid(u,t,n);if(H.push(d("tr",{class:["vxe-body--row",{"row--stripe":w&&0<n&&(n+1)%2==0,"row--current":v&&t===$,"row--hover":t===T,"row--new":-1<C.insertList.indexOf(t),"row--radio":q.highlight&&u.selectRow===t,"row--cheched":R.highlight&&u.isCheckedByRow(t)},b?_xeUtils.default.isFunction(b)?b({$table:u,$seq:p,seq:i,rowid:c,fixedType:h,rowLevel:f,row:t,rowIndex:n,$rowIndex:r}):b:""],attrs:{"data-rowid":c},style:_?_xeUtils.default.isFunction(_)?_({$table:u,$seq:p,seq:i,rowid:c,fixedType:h,rowLevel:f,row:t,rowIndex:n,$rowIndex:r}):_:null,key:y||I?c:r,on:e},m.map(function(e,o){var l=U(e);return renderColumn(d,a,u,p,i,c,h,f,t,n,r,e,l,o,m,x)}))),L.length&&-1<L.indexOf(t)){var o,l=U(E);I&&(o={paddingLeft:"".concat(f*S.indent+30,"px")}),E&&H.push(d("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(c),style:_?_xeUtils.default.isFunction(_)?_({$table:u,$seq:p,seq:i,rowid:c,fixedType:h,rowLevel:f,row:t,rowIndex:n,$rowIndex:r,isExpanded:!0}):_:null,on:e},[d("td",{class:"vxe-body--expanded-column",attrs:{colspan:m.length}},[d("div",{class:["vxe-body--expanded-cell",{"fixed--hidden":h}],style:o},[E.renderData(d,{$table:u,seq:i,rowid:c,row:t,rowIndex:n,column:E,columnIndex:l,fixed:h,level:f})])])]))}if(I&&O.length){var s=t[S.children];s&&s.length&&-1<O.indexOf(t)&&H.push.apply(H,renderRows(d,a,u,p?"".concat(p,".").concat(i):"".concat(i),f+1,h,s,m))}}),H}function syncBodyScroll(e,o,l){(o||l)&&(o&&(o.onscroll=null,o.scrollTop=e),l&&(l.onscroll=null,l.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){o&&(o.onscroll=o._onscroll),l&&(l.onscroll=l._onscroll)},100))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,collectColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(l){var e=this._e,o=this.$parent,t=this.fixedColumn,r=this.fixedType,n=o.$scopedSlots,i=o.id,c=o.loading,s=o.maxHeight,d=o.height,a=o.parentHeight,u=o.tableData,p=o.tableColumn,f=o.headerHeight,h=o.showFooter,x=o.showOverflow,m=o.showAllOverflow,w=o.footerHeight,y=o.tableHeight,g=o.tableWidth,v=o.overflowY,b=o.scrollbarHeight,_=o.scrollbarWidth,$=o.scrollXStore,T=o.scrollXLoad,I=o.scrollYStore,S=_xeUtils.default.isBoolean(m)?m:x,O=0,P={};d&&(O="auto"===d?a:_tools.DomTools.isScale(d)?Math.floor(parseInt(d)/100*a):_xeUtils.default.toNumber(d),h&&(O+=b+1)),s?(s="auto"===s?a:_tools.DomTools.isScale(s)?Math.floor(parseInt(s)/100*a):_xeUtils.default.toNumber(s),P.maxHeight="".concat(r?s-f-(h?0:b):s-f,"px")):0<O&&(P.height="".concat(r?(0<O?O-f-w:y)-(h?0:b):O-f-w,"px")),r&&S?g=(p=t).reduce(function(e,o){return e+o.renderWidth},0):T&&(r&&(p=t),g=p.reduce(function(e,o){return e+o.renderWidth},0));var k={width:g?"".concat(g,"px"):g,marginTop:I.topSpaceHeight?"".concat(I.topSpaceHeight,"px"):null,marginLeft:r?null:$.leftSpaceWidth?"".concat($.leftSpaceWidth,"px"):null};return v&&r&&(_tools.DomTools.browse["-moz"]||_tools.DomTools.browse.safari)&&(k.paddingRight="".concat(_,"px")),l("div",{class:["vxe-table--body-wrapper",r?"fixed--".concat(r,"-wrapper"):"body--wrapper"],attrs:{"data-tid":i},style:P},[r?e():l("div",{class:"vxe-body--x-space",style:{width:"".concat(o.tableWidth,"px")}}),l("div",{class:"vxe-body--y-space",style:{height:"".concat(I.ySpaceHeight,"px")}}),l("table",{class:"vxe-table--body",attrs:{"data-tid":i,cellspacing:0,cellpadding:0,border:0},style:k},[l("colgroup",p.map(function(e,o){return l("col",{attrs:{name:e.id},style:{width:"".concat(e.renderWidth,"px")},key:o})})),l("tbody",renderRows(l,this,o,"",0,r,u,p))]),r?null:l("div",{class:["vxe-table--empty-block",c||u.length?"":"is--empty"],style:{width:g?"".concat(g,"px"):g}},[l("div",{class:"vxe-table--empty-content"},n.empty?n.empty.call(this,{$table:this},l):_conf.default.i18n("vxe.table.emptyText"))])])},methods:{scrollEvent:function(e){var o=this.$parent,l=this.fixedType,t=this.lastScrollTop,r=this.lastScrollLeft,n=o.$refs,i=o.highlightHoverRow,c=o.scrollXLoad,s=o.scrollYLoad,d=o.triggerScrollXEvent,a=o.triggerScrollYEvent,u=n.tableHeader,p=n.tableBody,f=n.leftBody,h=n.rightBody,x=n.tableFooter,m=u?u.$el:null,w=x?x.$el:null,y=p.$el,g=f?f.$el:null,v=h?h.$el:null,b=y.scrollTop,_=y.scrollLeft,$=r!==_,T=t!==b;i&&o.clearHoverRow(),g&&"left"===l?syncBodyScroll(b=g.scrollTop,y,v):v&&"right"===l?syncBodyScroll(b=v.scrollTop,y,g):(m&&(m.scrollLeft=y.scrollLeft),w&&(w.scrollLeft=y.scrollLeft),(g||v)&&(clearTimeout(updateLeftScrollingTimeput),updateLeftScrollingTimeput=setTimeout(o.checkScrolling,_tools.DomTools.browse.msie?200:20),syncBodyScroll(b,g,v))),c&&d(e),s&&a(e),o.lastScrollTop=b,o.lastScrollLeft=_,o.lastScrollTime=Date.now(),_tools.UtilTools.emitEvent(o,"scroll",[{type:"body",fixed:l,scrollTop:b,scrollLeft:_,isX:$,isY:T,$table:o},e])}}};exports.default=_default;