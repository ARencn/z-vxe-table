"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _input=_interopRequireDefault(require("../../input/src/input")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function findOffsetOption(e,t,i){for(var n,o,l=!1,s=0;s<e.length;s++){var a=e[s];if(a.children.length)for(var r=0;r<a.children.length;r++){var u=a.children[r];if(o||(o=u),i){if(t===u.value)return{offsetOption:n,firstOption:o}}else{if(l)return{offsetOption:u,firstOption:o};t===u.value&&(l=!0)}n=u}else{var f=a.comp;if(o||(o=f),i){if(t===f.value)return{offsetOption:n,firstOption:o}}else{if(l)return{offsetOption:f,firstOption:o};t===f.value&&(l=!0)}n=f}}return{firstOption:o}}function findOption(e,t){for(var i=0;i<e.length;i++){var n=e[i];if(n.children.length)for(var o=0;o<n.children.length;o++){var l=n.children[o];if(t===l.value)return l}else if(t===n.comp.value)return n.comp}}var _default2={name:"VxeSelect",props:{value:[String,Number],clearable:Boolean,placeholder:String,disabled:Boolean,prefixIcon:String,placement:String,size:String,transfer:{type:Boolean,default:function(){return _conf.default.select.transfer}}},components:{VxeInput:_input.default},provide:function(){return{$xeselect:this}},data:function(){return{updateFlag:0,panelIndex:0,panelStyle:null,panelPlacement:null,currentValue:null,visiblePanel:!1,animatVisible:!1,isActivated:!1}},computed:{vSize:function(){return this.size||this.$parent.size||this.$parent.vSize},selectLabel:function(){if(this.updateFlag){var e=findOption(this.getOptions(),this.value);if(e)return e.label}return""}},created:function(){_tools.GlobalEvent.on(this,"mousedown",this.handleGlobalMousedownEvent),_tools.GlobalEvent.on(this,"keydown",this.handleGlobalKeydownEvent),_tools.GlobalEvent.on(this,"mousewheel",this.handleGlobalMousewheelEvent),_tools.GlobalEvent.on(this,"blur",this.handleGlobalBlurEvent)},mounted:function(){this.transfer&&document.body.appendChild(this.$refs.panel)},beforeDestroy:function(){var e=this.$refs.panel;e&&e.parentNode&&e.parentNode.removeChild(e)},destroyed:function(){_tools.GlobalEvent.off(this,"mousedown"),_tools.GlobalEvent.off(this,"keydown"),_tools.GlobalEvent.off(this,"mousewheel"),_tools.GlobalEvent.off(this,"blur")},render:function(e){var t,i,n=this.vSize,o=this.transfer,l=this.isActivated,s=this.disabled,a=this.clearable,r=this.placeholder,u=this.selectLabel,f=this.animatVisible,h=this.visiblePanel,c=this.panelStyle,d=this.prefixIcon,p=this.panelPlacement;return e("div",{class:["vxe-select",(t={},_defineProperty(t,"size--".concat(n),n),_defineProperty(t,"is--visivle",h),_defineProperty(t,"is--disabled",s),_defineProperty(t,"is--active",l),t)]},[e("vxe-input",{ref:"input",props:{clearable:a,placeholder:r,readonly:!0,disabled:s,type:"text",prefixIcon:d,suffixIcon:h?_conf.default.icon.selectOpen:_conf.default.icon.selectClose,value:u},on:{clear:this.clearEvent,click:this.togglePanelEvent,focus:this.focusEvent,"suffix-click":this.togglePanelEvent}}),e("div",{ref:"panel",class:["vxe-dropdown--panel vxe-select--panel",(i={},_defineProperty(i,"size--".concat(n),n),_defineProperty(i,"is--transfer",o),_defineProperty(i,"animat--leave",f),_defineProperty(i,"animat--enter",h),i)],attrs:{"data-placement":p},style:c},[e("div",{class:"vxe-select-option--wrapper"},this.$slots.default)])])},methods:{getOptions:function(){var i=[];return this.disabled||this.$children.forEach(function(e){if(!e.isDisabled&&e.$xeselect){var t=e.$children;t.length?(t=t.filter(function(e){return!e.isDisabled&&e.$xeselect&&e.$xeoptgroup})).length&&i.push({comp:e,children:t}):i.push({comp:e,children:t})}}),i},updateStatus:function(){this.updateFlag++},setCurrentOption:function(e){var t=this;e&&(this.currentValue=e.value,this.$nextTick(function(){_tools.DomTools.toView(t.$refs.panel.querySelector("[data-option-id='".concat(e.id,"']")))}))},clearEvent:function(e,t){this.clearValueEvent(t,null),this.hideOptionPanel()},clearValueEvent:function(e,t){this.changeEvent(e,t),this.$emit("clear",{value:t},e)},changeEvent:function(e,t){t!==this.value&&(this.$emit("input",t),this.$emit("change",{value:t},e))},changeOptionEvent:function(e,t){this.changeEvent(e,t),this.hideOptionPanel()},handleGlobalMousedownEvent:function(e){var t=this.$refs,i=this.$el,n=this.disabled,o=this.visiblePanel;n||(this.isActivated=_tools.DomTools.getEventTargetNode(e,i).flag||_tools.DomTools.getEventTargetNode(e,t.panel).flag,o&&!this.isActivated&&this.hideOptionPanel())},handleGlobalKeydownEvent:function(e){var t=this.visiblePanel,i=this.currentValue,n=this.clearable;if(!this.disabled){var o=e.keyCode,l=9===o,s=13===o,a=38===o,r=40===o,u=46===o;if(l&&(this.isActivated=!1),t){if(l)this.hideOptionPanel();else if(s)this.changeOptionEvent(e,i);else if(a||r){e.preventDefault();var f=this.getOptions(),h=findOffsetOption(f,i,a),c=h.offsetOption,d=h.firstOption;c||findOption(f,i)||(c=d),this.setCurrentOption(c)}}else s&&this.isActivated&&this.showOptionPanel();u&&n&&this.isActivated&&this.clearValueEvent(e,null)}},handleGlobalMousewheelEvent:function(e){_tools.DomTools.getEventTargetNode(e,this.$el).flag||_tools.DomTools.getEventTargetNode(e,this.$refs.panel).flag||this.hideOptionPanel()},handleGlobalBlurEvent:function(){this.hideOptionPanel()},updateZindex:function(){this.panelIndex<_tools.UtilTools.getLastZIndex()&&(this.panelIndex=_tools.UtilTools.nextZIndex())},focusEvent:function(){this.disabled||(this.isActivated=!0)},togglePanelEvent:function(e,t){t.preventDefault(),this.visiblePanel?this.hideOptionPanel():this.showOptionPanel()},showOptionPanel:function(){var e=this;this.disabled||(clearTimeout(this.hidePanelTimeout),this.isActivated=!0,this.animatVisible=!0,setTimeout(function(){e.visiblePanel=!0,e.setCurrentOption(findOption(e.getOptions(),e.value))},10),this.updateZindex(),this.updatePlacement())},hideOptionPanel:function(){var e=this;this.visiblePanel=!1,this.hidePanelTimeout=setTimeout(function(){e.animatVisible=!1},200)},updatePlacement:function(){var g=this;this.$nextTick(function(){var e=g.$refs,t=g.transfer,i=g.placement,n=g.panelIndex,o=e.input.$el,l=e.panel,s=o.offsetHeight,a=o.offsetWidth,r=l.offsetHeight,u={zIndex:n},f=_tools.DomTools.getAbsolutePos(o),h=f.boundingTop,c=f.boundingLeft,d=f.visibleHeight,p="bottom";if(t){var v=c,b=h+s;"top"===i?(p="top",b=h-r):(d<b+r&&(p="top",b=h-r),b<0&&(p="bottom",b=h+s)),Object.assign(u,{left:"".concat(v,"px"),top:"".concat(b,"px"),minWidth:"".concat(a,"px")})}else"top"===i?(p="top",u.bottom="".concat(s,"px")):d<h+s+r&&(p="top",u.bottom="".concat(s,"px"));g.panelStyle=u,g.panelPlacement=p})},focus:function(){return this.showOptionPanel(),this.$nextTick()},blur:function(){return this.hideOptionPanel(),this.$nextTick()}}};exports.default=_default2;