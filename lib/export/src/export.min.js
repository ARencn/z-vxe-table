"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../conf")),_tools=require("../../tools"),_vXETable=_interopRequireDefault(require("../../v-x-e-table"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var defaultHtmlStyle="body{margin:0}body *{-webkit-box-sizing:border-box;box-sizing:border-box}.vxe-table{border:0;border-collapse:separate;table-layout:fixed;text-align:left;font-size:14px;border-spacing:0}.vxe-table.is--print{width:100%}td,thead tr:last-child th{border-bottom:1px solid #e8eaec}.vxe-table:not(.b--style-none) thead tr:first-child th,.vxe-table:not(.show--head):not(.b--style-none) tbody tr:first-child td{border-top:1px solid #e8eaec}.vxe-table:not(.b--style-none) tr td:first-child,.vxe-table:not(.b--style-none) tr th:first-child{border-left:1px solid #e8eaec}.vxe-table:not(.t--border){border-width:1px}.vxe-table.t--border:not(.b--style-none) td,table.t--border:not(.b--style-none) th{border-right:1px solid #e8eaec}.vxe-table:not(.b--style-none) thead{background-color:#f8f8f9}.vxe-table td>div,.vxe-table th>div{padding:.5em .4em}.col--center{text-align:center}.col--right{text-align:right}.col--ellipsis>div{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;word-break:break-all}.vxe-table--tree-node{text-align:left}.vxe-table--tree-node-wrapper{position:relative}.vxe-table--tree-icon-wrapper{position:absolute;top:50%;width:1em;height:1em;text-align:center;-webkit-transform:translateY(-50%);transform:translateY(-50%);-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;cursor:pointer}.vxe-table--tree-icon{position:absolute;left:0;top:.3em;width:0;height:0;border-style:solid;border-width:.5em;border-top-color:#939599;border-right-color:transparent;border-bottom-color:transparent;border-left-color:transparent}.vxe-table--tree-cell{display:block;padding-left:1.5em}",fileForm=document.createElement("form"),fileInput=document.createElement("input");function hasTreeChildren(e,t){var o=e.treeOpts;return t[o.children]&&t[o.children].length}function getContent(e,t,o,a){switch(t.type){case"csv":return toCsv(e,t,o,a);case"txt":return toTxt(e,t,o,a);case"html":return toHtml(e,t,o,a);case"xml":return toXML(e,t,o,a)}return""}function getSeq(e,t,o,a,r){var n=e.seqOpts,l=n.seqMethod||a.indexMethod;return l?l({row:t,rowIndex:o,column:a,columnIndex:r}):(n.startIndex||e.startIndex)+o+1}function getHeaderTitle(e,t){return(e.original?t.property:t.getTitle())||""}function getFooterCellValue(e,t,o,a){var r,n=a.cellRender,l=a.editRender;if(l&&l.name){var i=_vXETable.default.renderer.get(l.name);i&&(r=i.footerCellExportMethod)}else if(n&&n.name){var c=_vXETable.default.renderer.get(n.name);c&&(r=c.footerCellExportMethod)}var s=e.$getColumnIndex(a);return r?r({$table:e,items:o,itemIndex:s,column:a}):_xeUtils.default.toString(o[s])}function toCsv(o,a,r,e){var n="\ufeff";if(a.isHeader&&(n+=r.map(function(e){return'"'.concat(getHeaderTitle(a,e),'"')}).join(",")+"\n"),e.forEach(function(t,e){n+=r.map(function(e){return'"'.concat(t[e.id],'"')}).join(",")+"\n"}),a.isFooter){var t=o.footerData;(a.footerFilterMethod?t.filter(a.footerFilterMethod):t).forEach(function(t){n+=r.map(function(e){return'"'.concat(getFooterCellValue(o,a,t,e),'"')}).join(",")+"\n"})}return n}function toTxt(o,a,r,e){var n="";if(a.isHeader&&(n+=r.map(function(e){return"".concat(getHeaderTitle(a,e))}).join("\t")+"\n"),e.forEach(function(t,e){n+=r.map(function(e){return"".concat(t[e.id])}).join("\t")+"\n"}),a.isFooter){var t=o.footerData;(a.footerFilterMethod?t.filter(a.footerFilterMethod):t).forEach(function(t){n+=r.map(function(e){return"".concat(getFooterCellValue(o,a,t,e))}).join(",")+"\n"})}return n}function hasEllipsis(e,t,o,a){var r=t[o],n=_xeUtils.default.isUndefined(r)||_xeUtils.default.isNull(r)?a:r,l="title"===n||(!0===n||"tooltip"===n)||"ellipsis"===n;return!e.scrollXLoad&&!e.scrollYLoad||l||(l=!0),l}function toHtml(l,n,e,t){var i=l.id,o=l.border,a=l.treeConfig,c=l.treeOpts,r=l.isAllSelected,s=l.headerAlign,d=l.align,u=l.footerAlign,f=l.showOverflow,h=l.showAllOverflow,p=l.showHeaderOverflow,m=l.showHeaderAllOverflow,v=_xeUtils.default.isBoolean(h)?h:f,b=_xeUtils.default.isBoolean(m)?m:p,x=["vxe-table",o?"t--border":"","none"===o?"b--style-none":"",n.print?"is--print":"",n.isHeader?"show--head":""].filter(function(e){return e}),g=["<html>","<head>",'<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui"><title>'.concat(n.sheetName,"</title>"),"<style>".concat(n.style||defaultHtmlStyle,"</style>"),"</head>","<body>",'<table class="'.concat(x.join(" "),'" border="0" cellspacing="0" cellpadding="0">'),"<colgroup>".concat(e.map(function(e){return'<col style="width:'.concat(e.renderWidth,'px">')}).join(""),"</colgroup>")].join("");if(n.isHeader&&(g+="<thead><tr>".concat(e.map(function(e){var t=e.headerAlign||e.align||s||d,o=hasEllipsis(l,e,"showHeaderOverflow",b)?["col--ellipsis"]:[],a=getHeaderTitle(n,e);return t&&o.push("col--".concat(t)),-1<["selection","checkbox"].indexOf(e.type)?'<td class="'.concat(o.join(" "),'"><div style="width: ').concat(e.renderWidth,'px"><input type="checkbox" ').concat(r?"checked":"","></div></td>"):'<th class="'.concat(o.join(" "),'" title="').concat(a,'"><div style="width: ').concat(e.renderWidth,'px">').concat(a,"</div></th>")}).join(""),"</tr></thead>")),t.length&&(g+="<tbody>",a?t.forEach(function(n){g+="<tr>"+e.map(function(e){var t=e.align||d,o=hasEllipsis(l,e,"showOverflow",v)?["col--ellipsis"]:[],a=n[e.id];if(t&&o.push("col--".concat(t)),e.treeNode){var r="";return n._hasChild&&(r='<i class="vxe-table--tree-icon"></i>'),o.push("vxe-table--tree-node"),"radio"===e.type?'<td class="'.concat(o.join(" "),'" title="').concat(a,'"><div style="width: ').concat(e.renderWidth,'px"><div class="vxe-table--tree-node-wrapper" style="padding-left: ').concat(n._level*c.indent,'px"><div class="vxe-table--tree-icon-wrapper">').concat(r,'</div><div class="vxe-table--tree-cell"><input type="radio" name="radio_').concat(i,'" ').concat(!0===a||"true"===a?"checked":"","></div></div></div></td>"):-1<["selection","checkbox"].indexOf(e.type)?'<td class="'.concat(o.join(" "),'" title="').concat(a,'"><div style="width: ').concat(e.renderWidth,'px"><div class="vxe-table--tree-node-wrapper" style="padding-left: ').concat(n._level*c.indent,'px"><div class="vxe-table--tree-icon-wrapper">').concat(r,'</div><div class="vxe-table--tree-cell"><input type="checkbox" ').concat(!0===a||"true"===a?"checked":"","></div></div></div></td>"):'<td class="'.concat(o.join(" "),'" title="').concat(a,'"><div style="width: ').concat(e.renderWidth,'px"><div class="vxe-table--tree-node-wrapper" style="padding-left: ').concat(n._level*c.indent,'px"><div class="vxe-table--tree-icon-wrapper">').concat(r,'</div><div class="vxe-table--tree-cell">').concat(a,"</div></div></div></td>")}return"radio"===e.type?'<td class="'.concat(o.join(" "),'"><div style="width: ').concat(e.renderWidth,'px"><input type="radio" name="radio_').concat(i,'" ').concat(!0===a||"true"===a?"checked":"","></div></td>"):-1<["selection","checkbox"].indexOf(e.type)?'<td class="'.concat(o.join(" "),'"><div style="width: ').concat(e.renderWidth,'px"><input type="checkbox" ').concat(!0===a||"true"===a?"checked":"","></div></td>"):'<td class="'.concat(o.join(" "),'" title="').concat(a,'"><div style="width: ').concat(e.renderWidth,'px">').concat(a,"</div></td>")}).join("")+"</tr>"}):t.forEach(function(r){g+="<tr>"+e.map(function(e){var t=e.align||d,o=hasEllipsis(l,e,"showOverflow",v)?["col--ellipsis"]:[],a=r[e.id];return t&&o.push("col--".concat(t)),"radio"===e.type?'<td class="'.concat(o.join(" "),'"><div style="width: ').concat(e.renderWidth,'px"><input type="radio" name="radio_').concat(i,'" ').concat(!0===a||"true"===a?"checked":"","></div></td>"):-1<["selection","checkbox"].indexOf(e.type)?'<td class="'.concat(o.join(" "),'"><div style="width: ').concat(e.renderWidth,'px"><input type="checkbox" ').concat(!0===a||"true"===a?"checked":"","></div></td>"):'<td class="'.concat(o.join(" "),'" title="').concat(a,'"><div style="width: ').concat(e.renderWidth,'px">').concat(a,"</div></td>")}).join("")+"</tr>"}),g+="</tbody>"),n.isFooter){var w=l.footerData,y=n.footerFilterMethod?w.filter(n.footerFilterMethod):w;y.length&&(g+="<tfoot>",y.forEach(function(r){g+="<tr>".concat(e.map(function(e){var t=e.footerAlign||e.align||u||d,o=hasEllipsis(l,e,"showOverflow",v)?["col--ellipsis"]:[],a=getFooterCellValue(l,n,r,e);return t&&o.push("col--".concat(t)),'<td class="'.concat(o.join(" "),'" title="').concat(a,'"><div style="width: ').concat(e.renderWidth,'px">').concat(a,"</div></td>")}).join(""),"</tr>")}),g+="</tfoot>")}return g+"</table></body></html>"}function toXML(o,a,r,e){var n=['<?xml version="1.0"?>','<?mso-application progid="Excel.Sheet"?>','<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">','<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">',"<Version>16.00</Version>","</DocumentProperties>",'<ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">',"<WindowHeight>7920</WindowHeight>","<WindowWidth>21570</WindowWidth>","<WindowTopX>32767</WindowTopX>","<WindowTopY>32767</WindowTopY>","<ProtectStructure>False</ProtectStructure>","<ProtectWindows>False</ProtectWindows>","</ExcelWorkbook>",'<Worksheet ss:Name="'.concat(a.sheetName,'">'),"<Table>",r.map(function(e){return'<Column ss:Width="'.concat(e.renderWidth,'"/>')}).join("")].join("");if(a.isHeader&&(n+="<Row>".concat(r.map(function(e){return'<Cell><Data ss:Type="String">'.concat(getHeaderTitle(a,e),"</Data></Cell>")}).join(""),"</Row>")),e.forEach(function(t,e){n+="<Row>"+r.map(function(e){return'<Cell><Data ss:Type="String">'.concat(t[e.id],"</Data></Cell>")}).join("")+"</Row>"}),a.isFooter){var t=o.footerData;(a.footerFilterMethod?t.filter(a.footerFilterMethod):t).forEach(function(t){n+="<Row>".concat(r.map(function(e){return'<Cell><Data ss:Type="String">'.concat(getFooterCellValue(o,a,t,e),"</Data></Cell>")}).join(""),"</Row>")})}return"".concat(n,"</Table></Worksheet></Workbook>")}function downloadFile(e,t,o){var a=t.filename,r=t.type,n=t.download,l="".concat(a,".").concat(r);if(window.Blob){var i=new Blob([o],{type:"text/".concat(r)});if(!n)return Promise.resolve({type:r,content:o,blob:i});if(navigator.msSaveBlob)navigator.msSaveBlob(i,l);else{var c=document.createElement("a");c.target="_blank",c.download=l,c.href=URL.createObjectURL(i),document.body.appendChild(c),c.click(),document.body.removeChild(c)}!1!==t.message&&_vXETable.default.$modal.message({message:_conf.default.i18n("vxe.table.expSuccess"),status:"success"})}else _tools.UtilTools.error("vxe.error.notExp")}function getLabelData(f,h,r,e){var t=f.treeConfig,o=f.treeOpts,p=f.scrollXLoad,m=f.scrollYLoad;if(t){var n=[];return _xeUtils.default.eachTree(e,function(c,s,e,t,o,a){var d={_level:a.length-1,_hasChild:hasTreeChildren(f,c)};r.forEach(function(e,t){var o="";switch(e.type){case"seq":case"index":o=getSeq(f,c,s,e,t);break;case"selection":case"checkbox":o=f.isCheckedByCheckboxRow(c);break;case"radio":o=f.isCheckedByRadioRow(c);break;default:if(h.original)o=_tools.UtilTools.getCellValue(c,e);else{var a,r=e.cellRender,n=e.editRender;if(n&&n.name){var l=_vXETable.default.renderer.get(n.name);l&&(a=l.editCellExportMethod)}else if(r&&r.name){var i=_vXETable.default.renderer.get(r.name);i&&(a=i.cellExportMethod)}o=a?a({$table:f,row:c,column:e}):_tools.UtilTools.getCellLabel(c,e,{$table:f})}}d[e.id]=_xeUtils.default.toString(o)}),n.push(Object.assign(d,c))},o),n}return e.map(function(s,d){var u={};return r.forEach(function(e,t){var o="";switch(e.type){case"seq":case"index":o=getSeq(f,s,d,e,t);break;case"selection":case"checkbox":o=f.isCheckedByCheckboxRow(s);break;case"radio":o=f.isCheckedByRadioRow(s);break;default:if(h.original)o=_tools.UtilTools.getCellValue(s,e);else if(p||m){var a,r=e.cellRender,n=e.editRender;if(n&&n.name){var l=_vXETable.default.renderer.get(n.name);l&&(a=l.editCellExportMethod)}else if(r&&r.name){var i=_vXETable.default.renderer.get(r.name);i&&(a=i.cellExportMethod)}o=a?a({$table:f,row:s,column:e}):_tools.UtilTools.getCellLabel(s,e,{$table:f})}else{var c=_tools.DomTools.getCell(f,{row:s,column:e});o=c?c.innerText.trim():_tools.UtilTools.getCellLabel(s,e,{$table:f})}}u[e.id]=_xeUtils.default.toString(o)}),u})}function getExportData(e,t,o,a){var r=t.columns?t.columns:a,n=t.data||o;return t.columnFilterMethod&&(r=r.filter(t.columnFilterMethod)),t.dataFilterMethod&&(n=n.filter(t.dataFilterMethod)),{columns:r,datas:getLabelData(e,t,r,n)}}function replaceDoubleQuotation(e){return e.replace(/^"/,"").replace(/"$/,"")}function parseCsv(e,t){var o=t.split("\n"),a=[],r=[];if(o.length){var n=o.slice(1);r=o[0].split(",").map(replaceDoubleQuotation),n.forEach(function(e){if(e){var o={};e.split(",").forEach(function(e,t){r[t]&&(o[r[t]]=replaceDoubleQuotation(e))}),a.push(o)}})}return{fields:r,rows:a}}function parseTxt(e,t){var o=t.split("\n"),a=[],r=[];if(o.length){var n=o.slice(1);r=o[0].split("\t"),n.forEach(function(e){if(e){var o={};e.split("\t").forEach(function(e,t){r[t]&&(o[r[t]]=replaceDoubleQuotation(e))}),a.push(o)}})}return{fields:r,rows:a}}function parseHTML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"text/html"),"body"),a=[],r=[];if(o.length){var n=getElementsByTagName(o[0],"table");if(n.length){var l=getElementsByTagName(n[0],"thead");if(l.length){_xeUtils.default.arrayEach(getElementsByTagName(l[0],"tr"),function(e){_xeUtils.default.arrayEach(getElementsByTagName(e,"th"),function(e){r.push(e.textContent)})});var i=getElementsByTagName(n[0],"tbody");i.length&&_xeUtils.default.arrayEach(getElementsByTagName(i[0],"tr"),function(e){var o={};_xeUtils.default.arrayEach(getElementsByTagName(e,"td"),function(e,t){r[t]&&(o[r[t]]=e.textContent||"")}),a.push(o)})}}}return{fields:r,rows:a}}function parseXML(e,t){var o=getElementsByTagName((new DOMParser).parseFromString(t,"application/xml"),"Worksheet"),r=[],n=[];if(o.length){var a=getElementsByTagName(o[0],"Table");if(a.length){var l=getElementsByTagName(a[0],"Row");l.length&&(_xeUtils.default.arrayEach(getElementsByTagName(l[0],"Cell"),function(e){n.push(e.textContent)}),_xeUtils.default.arrayEach(l,function(e,t){if(t){var o={},a=getElementsByTagName(e,"Cell");_xeUtils.default.arrayEach(a,function(e,t){n[t]&&(o[n[t]]=e.textContent)}),r.push(o)}}))}}return{fields:n,rows:r}}function getElementsByTagName(e,t){return e.getElementsByTagName(t)}function checkImportData(e,t,o){var a=[];return e.forEach(function(e){var t=e.property;t&&a.push(t)}),a.every(function(e){return-1<t.indexOf(e)})}fileForm.className="vxe-table--file-form",fileInput.name="file",fileInput.type="file",fileForm.appendChild(fileInput);var _default={handleExport:function(e,t,o,a){var r=getExportData(e,t,a,o),n=r.columns,l=r.datas;return e.preventEvent(null,"event.export",{$table:e,options:t,columns:n,datas:l},function(){return downloadFile(e,t,getContent(e,t,n,l))})},handleImport:function(t,e,o){var a=t.tableFullColumn,r=t._importResolve,n={fields:[],rows:[]};switch(o.type){case"csv":n=parseCsv(a,e);break;case"txt":n=parseTxt(a,e);break;case"html":n=parseHTML(a,e);break;case"xml":n=parseXML(a,e)}var l=n,i=l.fields,c=l.rows,s=checkImportData(a,i,c);s?(t.createData(c).then(function(e){"append"===o.mode?t.insertAt(e,-1):t.reloadData(e)}),!1!==o.message&&_vXETable.default.$modal.message({message:_conf.default.i18n("vxe.table.impSuccess"),status:"success"})):!1!==o.message&&_vXETable.default.$modal.message({message:_conf.default.i18n("vxe.error.impFields"),status:"error"}),r&&(r(s),t._importResolve=null)}};exports.default=_default;